---
role: role::allinone

localexporttag: yulallinone

# use letsencrypt staging for now
acme::certificates:
  # www and webmail are both hosted from nginx so it needs to be SNI (SAN)
  # yamllint disable-line rule:line-length
  'www.bardicgrove.org www.yul.bardicgrove.org webmail.bardicgrove.org webmail.yul.bardicgrove.org':
    use_account: "%{lookup('acme::certificate::use_account')}"
    use_profile: "%{lookup('acme::certificate::use_profile')}"
    letsencrypt_ca: "%{lookup('acme::certificate::letsencrypt_ca')}"

# disable ocsp stapling, we're on fast rotation certs no need
# plus postfix does not support it which causes problems if the certs
# are issued with it turned on!
acme::ocsp_must_staple: false

# msyql
mysql::resourcetag: "%{lookup('localexporttag')}"
mysql::server::remove_default_accounts: true
mysql::server::restart: true
# yamllint disable-line rule:line-length
mysql::server::root_password: ENC[GPG,hQEMA4nUKMUJFtKCAQf/fEDuK3a3RVnQwCfroZseqqb2iv8/VXSoGBKmOXjsgkDzByWgzc1M9zcDXBd2lgyYYVxIxO6F0h59jkFhs00O107HLF3RgW1HXLL6TUyc750YNzeC7sORh7Ut66b3y1tI8Rizky6PyFHdJo0pmNAtg7k0Z50TPDA6ZnbvGZvAw3sjScsUrezQvYgNzBdPH4IpknCVOnVqM708+wT5CRmQ+ZHr7Qre2FDDhNAukdIRDdLh/Sz/OlZqggFWw0//GyC0KlWKhw0Hc7kdy5nGvpuX8EiGB88ORjiXFhL7PVvrSqv+pGokKLVgn6qdsI+FlNutTfgGA8D6AG0KaK0pccu7SYUBDAPEqAo7p1ScpQEH/3NS2CPZQg5HKqS/4VDiiosDGghdBjcEmPVIUdGMZnfx/L8CLJqM1f4rHyqWM/gKRZ5Esmkm5wYj4uHhRpVuKb+cTV9VHWoI2aNWjDFvOyWRpcRLRR7oyxah0rVBVNcsg/xh8Ge8pfgQjLbgOvPbqNfCxe86fLJH2jTZYXEoyEoKgBPUherY283j2jQGGHNRm58RSpJVyVAfmr+ZXaTYqtiriej+yi5LlknrOO4ePIG21oezxrm8szFPDmFAKS4dGe97KLICi1nbXEG4HBz4lu6ZUMLBx8UdsgbUa2abOXJs3PE90aFSs7m+7eHp+8iMRFE3PQDp8Wlm0tFZ/IbquNzSZQGTjmveuIzX2YFUbPIthZD7gPkoqGEQ5uP+S7sOImRejL9x/2a1P3bAon12gO4TqI59c/ylF72ddvWobl/eMRO2CPcjTbLRdEsdG9GZ1xN7wBqlqAlsa6/kdRyh+aK3GLl/k+uY]

###### MAIL CONFIGURUATION #####

# clamav/freshclam
clamavmilter::new_clamav_packages: true
clamav::data::manage_package: true
clamav::data::package_ensure: present
clamav::data::package_name: clamav-data
clamav::clamd::config: /etc/clamd.d/scan.conf
clamav::clamd::package_name: clamd
clamav::clamd::service_name: clamd@scan
clamav::clamd::config::local_socket: '/var/run/clamd.scan/clamd.sock'
clamav::clamd::config::logsyslog: 'yes'
clamav::clamd::config::tcp_socket: 3310
clamav::clamd::config::database_directory: /var/lib/clamav
clamav::clamd::config::user: clamscan
clamav::clamd::config::allow_supplementary_groups: 'yes'
clamav::freshclam::manage_package: true
clamav::freshclam::manage_sysconfig: true
clamav::freshclam::package_ensure: present
clamav::freshclam::package_name: clamav-update
clamav::freshclam::config::database_directory: /var/lib/clamav
clamav::freshclam::config::update_log_file: /var/log/clamav/freshclam.log
clamav::freshclam::config::log_syslog: 'yes'
clamav::freshclam::config::database_owner: clamscan
clamav::freshclam::config::database_mirror: db.local.clamav.net

# dovecot
dovecot::plugins:
  - imap
  - lmtp
  - pop3
  - sieve
dovecot::cert: 'mail.bardicgrove.org mail.yul.bardicgrove.org'
dovecot::config:
  protocols: imap lmtp pop3 sieve
  hostname: 'mail.bardicgrove.org'
dovecot::configs:
  '10-auth':
    auth_mechanisms: plain login
    auth_username_format: '%n'
    disable_plaintext_auth: 'yes'
    passdb:
      driver: pam
    userdb:
      driver: passwd
  '10-master':
    default_process_limit: 200
    default_client_limit: 1200
    'service auth':
      unix_listener /var/spool/postfix/private/auth:
        user: postfix
        group: postfix
        mode: '0660'
    'service lmtp':
      unix_listener /var/spool/postfix/private/dovecot-lmtp:
        user: postfix
        group: postfix
        mode: '0660'
  '10-ssl':
    ssl: 'required'
    ssl_cert: '</etc/acme.sh/certs/mail.bardicgrove.org/fullchain.pem'
    ssl_dh: '</etc/pki/dovecot/private/dh.pem'
    ssl_key: '</etc/acme.sh/keys/mail.bardicgrove.org/private.key'
  '15-lda':
    recipient_delimiter: '-'
    lda_mailbox_autosubscribe: 'yes'
  '20-lmtp':
    protocol lmtp:
      mail_plugins: sieve
  '90-sieve':
    plugin:
      sieve: file:~/sieve;active=~/.dovecot.sieve
      recipient_delimiter: '-'
      sieve_default: /etc/dovecot/sieve/default.sieve
      # make default visible to users
      sieve_default_name: roundcube
      sieve_global: /etc/dovecot/sieve/
dovecot::sieve_filters:
  - SpamToJunk
  - default

# opendkim
opendkim::keys:
  - domain: bardicgrove.org
    selector: yul
    # yamllint disable-line rule:line-length
    publickey: "p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxwBYMTtyDn19IM4Fjmgnu5/fVIIaY0F5G5jDfenQiwFIU06hXkuRWqCLPyIbU6GyyDC9LFm+o58mPAM09tBqBHEqXFB7OMlwx+WYj3G6uhWAXs3NNHH+mZbVm14t8oqjjgJfjdUipbIe2l1bgbBvc+8CDfGEq7TqIWJoVbonw4hqURUyO897HHUo27SosjumRNUKda2dmCzHnNE4hysGM2oE6KbNnXeH+9BijS6i/PQP/RXZO4nZN7QHMnvlS35uJKsQeGrMj/iR8Xe75yVxR+qFxUUL3fkQLHsNWCRODNY7a1vO5ihO6ZP2juePkT8xgAHlHCbFTfd00/2zVEA5pQIDAQAB"
    # yamllint disable-line rule:line-length
    privatekey: ENC[GPG,hQEMA4nUKMUJFtKCAQf7BAprBZSNPPR+6c1X1JHWApCgoyZ2av+RgXlSFoIDvBGxTmNDam1difd7XWUIC6rLd69jcG8eT3xIJUw2YhcJcINmL4woFw3a+G2SpDUQatvFpKt6GNHI0Wa4nbO2M9wJw54OSfpB6K9xUTHD48JhkCaVtzULdXqpM+o0KewW/m7zmQfeL3Q5UgUMai1PB5whdjl4bhrckuwqGOvy6P3VZi3TSCvI0WT1gljgsS6pgMFawoHeAszj80gkX9/rGjJ+a1CSPRCRkX2Pr7O5uvYuRZ4V+73/BT9h0c5zeGAyUIwh4AdAdPiaWfhK5N8BihzSyJkv46o+J9aaaReMWDQC9YUBDAPEqAo7p1ScpQEH/RdS5Yr8QR2ijht/XBqrh/3ge57FtG5UBQJJ+9czUDE124g8jaC6OGBxGHyJjOLutpUJjqydYTglrs8I+IfxzAgXi/tvRqfwbYxRCDtQCQX8ocxJdQokpYkrnLM+iBS+FfHlDimI7lMNmlHMwivbOTq8OF++Qn2OZchRS9UEQlYCKHY9+wtdyDVwpA8LLUFfTFb19qZE9TxBafBCLRNRL1iqIAKbrBy5rSaBuL2CnClTlQeFNEhXdG3llviZTWsVSGA0eJdCihj/3TT5kSi8YQ+WDUx4et0PSPCqicCzPMREP4BDI367mWiZN9Z/+J5j+FF4ssdDb9q/OIMOjbevu97S6gGpaPs7X85eJSOBTTYCZzLfTdgzdyb69q3CPf9PjI27S8uL3DvWhld5zx5KpDw7GjukNf35mhxpE4i0znDxUilRjQAoTA9UNopgDr1cCms2vJA+eeCMeqP4EI/rznCkfC7V9YrQnNJTRstJLFXOing1Pt3TXZI2mZyGDwUL/4uyP6tBCLuTMFsLPQC+a24Odmp1yUnzohvFt4m/aziAWsGqcDawWhPWYr1aQCqofDZdDnSR8afAMPZGPA4fQLKCFiI+eEyrQF/Rt/ASuPPaKD+p1Fcl9v/FsnjQmspJLIH9qB8cjBOLzdlvV5krB0HeoScXYVnc8C2Zn6MVFOC6AyeNs1bdtaoS9SJ3vtawzdxLsjCKPZUQnRDByc9K4lTBjIMhfJbyjAXX0W+H4XSu3bM6Xon5ix2SE8RMeaI+PvnhVpDPzIfQJ5D/DCuctOcKbbmYmu156NpSrVYDlzXDsn7G88fEdpfdZam4m8jvv/6TMGs5/zOpmdQAlaSrtUwJEms5svN16SbQjNPVsih5ywsUgK6Dmad5p9prQkwqEiCnnpm1cvhxg7zjEF/7FPVcpCmyfiiKdCXzagk3qfqqVRdrAqltgoyNE1nITTY4Wn3BXhZNZqQ7yFPidbzp0/vk5XJ6BykpXyUFY5/WhmgPIXmLyN9tiCPkVVNEmv+Q9k5nWKza9i1qvoCfcb4RQKI1kCHV+yz7YukmPOLPl2e4t5WByD4/SgXw2rO/cpiexyiXlJn16SJZJfpK1KeCHz/1PX/GnX2JYrE7Y0U0RQI3G/EQdkbruRsGpTKa+zH5HGo90zepDH5eNoOZaF2cYRTlpnPcj+VI2DMVTZYBT3u2kvZaRKcJ50ocfzhCfEAt9jvLFMyYc+atpbFBYVTp5Beb0moZzdpbUb9DWRnGrzij3ksJ/O1CDVKbkPJBAm3sl0cUIFoibrQRg9LMw5VHzKhTiYr11/qYdm4o0cxTERkQAOMqOO5GNxyLFn+Sxw09ZfCfo+wZAb9h4YcVSAhKegUaOe0mwLApceVZdEFNmLuD5zz1ko2W6ddtcFSEqKl2B7ZgRuPlw6+Rf92j20hQWImCf9JxrUFms86aN4P+VCL7dxkLVFwR6PpvdiCczrVuhnhkbB3NlIMLZbKxS7RXWAUqwFaQBSTeSB1v8NVFM4uCTGVcgnTiflxSoxWPSoXFK6TmC8dYH3qrfiM7WKnAhPzc1Wfoim0x1f9zBW0R95cKA2KMcH76upe7syk6sxwGUJPT8cuM/VS9FTJ1I4X6K74R5PsbckhIWkIYKYs9tuZ7WyCNj1U3RYHk3NuDOK1NGsHJfIbCQbOuy5QV6jFwsIYa5q+6Ml1jk4KywbR3fv8LMYDAi3gA2ByTjmeo0nAwa40kVD1qXvW9+rCmzVHZXVJiYoeVLot6uqU0DBW8WYnK7FLAtCxlryiALVTbNdB/hwnqCb6cIBsVPGUIbDR8PPwT0VFVrZqRgvqK3AMd80q7VNSYGeib5ggAtJgEnXVas7J5+LNK5/4e5Op/gznEBtnOv5QEL/c/itcfPGHZj+t8nwf9BjHgDL4O9yhnNGZjnlewtoX5nf0C/gZmdnOyk36/1Mqkgx76kPbrVu+NuU4DIzHt8WWo++w+Iyx4jZBwRnMynbeCiTVL7Z9j5Jr9MMJ5d3i5SwkpiZUeOh78OQqGH0k9ZuDpYoFlBmKWFYVfSDXos50I98eAYFbo6pTAFwuHqHsS/dwJcbB6eaipW7shdFX2ewb5Tz4NsfYNafwPprg8e48tx7x5E9VRIrYozg2t8zW4qi2VMUG8VdYGJEc=]
    signingdomains:
      - '*@bardicgrove.org'

# opendmarc
opendmarc::configs:
  # yamllint disable-line rule:line-length
  TrustedAuthservIDs: mail.bardicgrove.org,smtp.bardicgrove.org,circle.yul.bardicgrove.org
  IgnoreAuthenticatedClients: 'true'
  RejectFailures: 'true'

# postfix
postfix::configs:
  dovecot_destination_concurrency_limit:
    value: '1'
  dovecot_destination_recipient_limit:
    value: '1'
  home_mailbox:
    value: 'Maildir/'
  mailbox_transport:
    value: lmtp:unix:private/dovecot-lmtp
  # We use ~20MB as the limit as _most_ major providers will reject mail much
  # larger than this
  message_size_limit:
    value: '20480000'
  milter_default_action:
    value: 'accept'
  mydomain:
    value: 'bardicgrove.org'
  myhostname:
    value: 'smtp.bardicgrove.org'
  non_smtpd_milters:
    value: '$smtpd_milters'
  recipient_delimiter:
    value: '-'
  smtpd_milters:
    # yamllint disable-line rule:line-length
    value: inet:127.0.0.1:8891,inet:127.0.0.1:8893,unix:/run/spamass-milter/postfix/sock
  smtpd_recipient_restrictions:
    # yamllint disable-line rule:line-length
    value: 'permit_mynetworks, permit_sasl_authenticated, reject_unauth_destination, check_policy_service unix:postgrey/socket'
  smtpd_sasl_auth_enable:
    value: 'yes'
  smtpd_sasl_path:
    value: private/auth
  smtpd_sasl_security_options:
    value: noanonymous, noplaintext
  smtpd_sasl_tls_security_options:
    value: noanonymous
  smtpd_sasl_type:
    value: dovecot
  smtpd_tls_auth_only:
    value: 'yes'
  smtp_tls_CAfile:
    ensure: absent
  smtp_tls_CApath:
    ensure: absent
  smtpd_tls_cert_file:
    value: /etc/acme.sh/certs/smtp.bardicgrove.org/fullchain.pem
  smtpd_tls_chain_files:
    ensure: absent
    value: '/etc/acme.sh/keys/smtp.bardicgrove.org/fullchain_with_key.pem'
  smtpd_tls_key_file:
    value: /etc/acme.sh/keys/smtp.bardicgrove.org/private.key
  smtpd_tls_security_level:
    value: may
postfix::mta: true
postfix::myorigin: 'bardicgrove.org'
postfix::relayhost: direct
postfix::root_mail_recipient: 'tykeal'
postfix::smtp_listen: all
postfix::use_dovecot_lda: true
postfix::master_entries:
  # yamllint disable-line rule:line-length
  - 'spamassassin unix -     n       n     -         -       pipe user=spamassassin argv=/usr/bin/spamc -e /usr/sbin/sendmail -oi -f ${sender} ${recipient}'
postfix::master_submission: 'submission inet n - n - - smtpd'

# spamassassin
spamassassin::pyzor_enabled: false
spamassassin::razor_enabled: false
spamassassin::sa_update: true
spamassassin::service_enabled: true
spamassassin::skip_rbl_checks: false
spamassassin::spamd_min_children: 1
spamassassin::blacklist_from:
  # yamllint disable rule:line-length
  - ENC[GPG,hQEMA4nUKMUJFtKCAQf6At4zyKJnWXGEjx8DK7Athbrvk7yl/sQLeDwIZUC9rkacbh82AODXZbkSmdStir59JfPw23f6EJM0qNSvORO4kKpfRlhVeq9rPVqa/SGbxD0s1jzugaAr625Pp0XLbvjLwFl4KGcyEZcanoqMp/Y5CBpW6TDb4iZbrYhbd8W+mtWTCQV6T84Xo3kPLWKRs3BZgUiFXe7QmU2nXDzCgq+bMCMUv2nGu89ClnWgIcXcPG8BQfw1wMJLnLulbKtdD3f+83TbaqgNsYNfWxOoJ84UjlOGVk0sL7sxlP4SMGMtVRW10espnobziwPD0VGe2J0W5zcZJ2jiP6r6UqzEAeNI+oUBDAPEqAo7p1ScpQEH/j75VkOYcPBHKN2xV1gQVMn4wOxCrMGEZ06LxOcEZ56f+3ac3HdQ6DDRC7QoNjdoQjkjZypegMFg6CI3Dk98YZnXK+RaTpWxyQHFaNZfPozXORDLsMiba4v1srWSJ8ogxNaaaQdvcO0DUA9MBLddxmWx51VxQS2Cj/3npwXQ/xJXyMS1Jwi62UiiI2EcRRjubMHSPDXuLCMoosnB7PVBQ05SclOZrKuQTrV0ymRuFE2KBpM1ACd2U0n0lURN86cUPlBi0GlmJU1G5GCBkTVWd6+3w7qOsG2AP2/VSDdxL/+lQC6DClTcsQOkHsX3UxbFBt4+yN4jNlNyEI3aV1S6JsbSTwFekDNb5ga7kcQTTJepUJM0Fxw4fVCPr+hCukHNMwL8VqH5MptbAM+IwedhH4Iux8j4AmOH4JbBzI4nYz66JJLhm2HnbFwX5XbJZIi5Q0g=]
  - ENC[GPG,hQEMA4nUKMUJFtKCAQf9Fx8wExeERUkz0jjUkftXTk6oolI4mIuKdTEFU3mBweJkdvF52u0A+fXyRFshzR98HelNKVj68q5/HP0K56SGj5WT+EwU23IGLMCzX8Ez7gJR2hHdrL352jp3cpVapMVMApLtDytHbdfVI7rSCIMq6jwhkyxxQoI8YbcDOrtyeLJd7gNWD8ZBC0yT/j9N6K0dtUFWWAg1g2jaZdWXaZlHs3li2PGzN/bsIfcJZNEPuawhINBEZ+eJ6QUIVnTFE1CUpwV8IbN38JrxjgP+cfSJIKXhpsQKphP33w+czou+51JmaDhBynPXpRs6sifII+cHatxqlGVk3kfh9tlST0Y+UoUBDAPEqAo7p1ScpQEIAL6/xg0j5HMcSVGSKtM0iHnpS4QGFzSsgZZ0vxZyNyvMhLn1qs/0DlfRn/uEkr0AlRDcWQbLE54ew5xLUuyowUcmR5OuX9XkKhAZd9w32THK43ZeXZRWJ+WbVpfQ0U46+OhskbrY5wIBXqN2ueqH5rqpmV5k0JanLbguZnSx9q9UulmrqulwOlINjm6Gw6g4FDmPJysrnRKp01h0SQyLeqCDz11m9iaQgp3042x0y9gKfF8ScsLFOcaj8QBFlCaRlnCYHxYI3gmf/b2urmfhW6gGaRtN2nuJxuLK5P44WC8uNLcu9PCFAcu9y/3qJXBXt079+64w0LrHiGWeTZKPvZvSWgEifDEHFemtXZkCnDBtIBxk+j0pIN0t0p6imumqvhlRBt8Dx+z126T16uFa5Ikb7QPQ8Fn08+99iafI3u7wfwQXjyCzJ+BC08JCRESapXr3UORraZpHLOKEZQ==]
  - ENC[GPG,hQEMA4nUKMUJFtKCAQgAnL6iKDVU2GYAKdgFc7rGt1af049jgpB+K7HnZ1CkGppnWURU9IVPpQW/AXZK6mRNFdk684+u6UZcSVpw9ZJYHzE+TcEOJZjWiCbZsIhL+1fWIflOerTMdCz8HTnhWPEbP6TYN1VAkFpJ+f+qDF/qMw2iBtcZpYVomwBDYbph7whGeP420BLIR0xHUAdsQCr3om6CJnF+3mwt36t4q6DUrskxtXzFpkLFRjnEJVxWM9ZwgDR+UoTCgXN/R4zwZmiD71oqRdtMExt+M2l60hF4g2oGfksunS1xQtFIJ7Z6Xz0HpsKSyMo6M+4LnNCsDBUbPMZc7FCZMWbFal1fHi8l3oUBDAPEqAo7p1ScpQEH/3kSd3MTXdAXqIId7M31+uQXwv2hZI0E6q22OX1DmmMT8Dm+9ehMQzOnqrCAraZd/wuAndpWbIGFEQl7izBvuawuGt86kk5Vb5noyOLFcootukdHTRanCyNpH4X0VsHezmHBqD1SZxez4Y1SXpmok126jg3yLIGA80RswdQbuMsqzzwlzzl1/jKPuimLga8Y5ISZoKpCfg6T/V5FXb2/aYk1HfpFcwVGcpcBVpR8KCZGLvT+7aO4O+8jlZtWFROT4GeJHiliDvJaPkIj6Y42GAoIpbykY9tpd1U/o+Ij9nQwaX10D5BuRICsCMq/a5W78DbfESW7MQ/BldOu2ey/Em3STAFpc2GpmaQsPuUH88O+flCdOMQIFobUzh31uEfzZAmyGCD7lQb7M4UirbC0UFpZvBbIwpHjm4mNcCWrJLkjBs6xANCPUkNxT5ORMWw=]
  - ENC[GPG,hQEMA4nUKMUJFtKCAQf/TWzyDy84+1zsnCs0QGjII8eaMP2Bo6oDYgQqkPz7uiVhYefHFxhxQSybo56dTtaFYH+Jm8OqgoNLhgmC6bjIkMfykJvBcuY33Rj/ExwUz0Fwpb1cZ+FBhpgdgJeVvS0NtYFb5dCXMZJ08pqcnpjvrxA04f1C6JuUswt8hmVQX7ivLMBR6G262zUz3hDwmm6nhbjISJRr6+3GDjEekFznM6CbhD85qIlcH8exYYWKOfVHzeLy86o61v3QJKnGuq9WL6BhXuK+QRL7lrCS3qgS88z8H5e89C7LFQFnxmEyxoevgdfmOYamgn5KZmlb40jMjo5ubYA4TkmPBFFZuCxTUoUBDAPEqAo7p1ScpQEH/RS7UgRKtUY0UD/IM3cZ5FfKdDFSb6AQ0PqX76kWTK7PrugjTqHSxS4wqt7RxQd+7xZ3RRgn51AAFu/ZXOhGRWTT+ek8K5sPx25SktHtqzVurRRwXFb8501plNzPKyTb1R46hwDQRD9+5f/r3qFrkvcdKdRnBxJIgCMqUPAjHVWUYV4O3JN4pMLocsE0s0QsX/+kA9xHhSMHjGoqgERZ2EFYEuj98VuKxn82dGXVisnKYs8mCK3gKDtWPnMkBb8NtslgMSWSFDojQe/Q3wkU4Yaqrk+Zld4xX6YNTFiX8c6k6IszHPo7RoYTUI/Fia4j8xmCZAQ3rbkijqsmBMe4GsLSSgFAsO/ELaUqAGin77b3RKR87u07QUxD0hcxg+TqyJ37qzxphMOPLhv6IjMtuIHUs88shPFJMVvJiw5R7nTf5FsRz/hRZQxc1MSi]
  - ENC[GPG,hQEMA4nUKMUJFtKCAQf8CX3BDu2lN30qK4ysPTL9P8CmN7vx6ylHQsAM3eF4Wbia+hDi1j9F4E/wjl41TITgKOTeRimqmZNehsw7PZSUbvpTEt/No9ECUmiO1JNCGcsBQYeW0Sea59PHqPhxN3mFyMiCQxWc8RsUhs9JqmE81xrTI8oNZCVotxoweBwkYYosORSyD21jX+zSr5U9IZP7NuTO59XYZtVFgszTOuSETjZBTEaOqg4Tm5nQTUTRfpJIkFQLNnxDIu7pm09IxlxKUn/Ert/t9rZz6uFzTWHh8lABy3W8EnLfwQdGy1xmv2Fro0isoGhtU6ynC7oet2Ao/I1bmn5NsZ+gK1vi9ss6k4UBDAPEqAo7p1ScpQEIAMd6MbxL8bPLA9QwXxhgTWErR+OBQMLgKsmhuHX7dtzbh2SCFuETsFcQbw2uA6VYj5sEiEVTFcYgFX+cHqVXksfG/nMDK1E7EGfp0SVQjmvoVLaNlYZr9I70x3HQEZQF5zDfLma3t5VHBGmLskmll2rfhxYshcJDmXetjdpe2lAq53ICwPY6V0zlOW/zhrfik73B+3SjaoH9/LN6EeSbtafaY3zbaAahSIH3QHs5dZT1U8D9tzHHpbzLeL2g8NFQlN0s6B/E9l2RYVAOskFugAC4TvXc4XSul8W7OWQKS302kwXtUkUy0jXEkEFHwhkpUL26nCUzru5n5qMrLAjK1JLSTQFS/82Ji3mCKm8HHlK3ljpvpmNQCSZevM0A/WbMQ8x4B90m9aSQkguWdypMX33VzJkmmSPfYmvEKoHH9o7QWltAUBEDJk+3DKhQlG9H]
  - ENC[GPG,hQEMA4nUKMUJFtKCAQf9Er3t/NbDN5QkmkxpVzp8HNHePbFZy0+YI2+rqfcaZD6EdhnUqeJpSEgw1JFfo47izA0GhI7m4H9MLFATVURpQjmgDNSwqvyipvyMSbV1+a39JzsaWoUfmp5iZyrGW/Q9mnJhO7hYb6rOdzoLK3mugGlgVaVxuACIwJkbYNq5EbKwAyJ5ZG+u1fNfudfiCnU15AR6GyZU9QivCncXlzOLSVLUn2+KlFybzZlqhI4R1COHkf8CImh7/eZj+wv64XVYUtjwKFL9QuM2F7M/aMOB+/hjIo4fVdCPyi0NqXIbnMjlS1KOYw9qZcq+P/UFhGl5MMrwcrRGd2XG0Fu2/hwvb4UBDAPEqAo7p1ScpQEH/1Dq7/L1fx/xY5KzE7Jn+Q52mvin/QIB7fOSP+rP50VOkYd90HndXJ2VQWYnSLjsNJ/32GhidUdTF+bBA3ZDu0KVga+wxCX/NePZqSmjshhiPx9CFiJUNMczLyd2hv9Z1C/MLXKsFVeh4YA1BmGGLh0yWiDi5YG/uefY71DCCr1WOFXSbzogJ9d/hWG6gqfu06R29gQ7Qmm0+q0FmLWy02ZbpBPlySTwJOqj1hEgt1FNXSj3FdLL1851WeNzaJC1ya5JzQHzN7w2/y4gjNd2td3RD4AkujlfUUH/CP3NCRy1/8NPuwrsL9eOz6nj/im5N45wsPrbneW4TytqUUJ9DSnSTQGCYOFURoTuXBQiFv71UwERVRdtVFdhvuo9zM8NvUHelLkjj5zon9LtTiben+3TLsT7CiBtRzbByhgGteUnnJZf+eDaIIFnMafK+xdc]
  - ENC[GPG,hQEMA4nUKMUJFtKCAQf/eI9JIdTceH1pioLqsJxsCzkrMJrpBd+LOej8xnzrSEw+eqagZkzHz5JnzviZpUmMBXWNUIc8aDR96xeOc86gAGfQMUmoUtqBmyP4mF0ra6kOy8iZjTXjW1EIBLd7jy0LbVfUV9jxQ+gB0BLfUPtdhNSU3BtoBLTWKlikSTtnP3TytRFn/mFzu9EB9hYYAsAI2ie3n5tYtq0nMuuUKAY1V4rTetRyqBmCanuYvaT6ibYAj7XfoLxwH4kyKMXhOWSH5AoUpIWnom0JoUUUDq3ETJvGMcC6pssPeNt+ze8wIHpBmd1Rc/Jl1Q54CeG457GJp8flPeRROr4zVBip53HwdoUBDAPEqAo7p1ScpQEH/2zn4z4rqopKgWbVIpNfc53kifmCTCYneEt/drsoo50buUmIErs0NyPP+FCcO8AdNefb1Oiy2gVKNkKZPqrwLeP0Z6zxJVVswVt23Q47BL9bDQW4fmnxN3JkcS+5yO9PWxPqhqWsWlQVxVEvErExvgrcDbZWNbFty7WkGx0ib7gbR7kj0DF5gUiqS5EwvBfiUtk7e0ve4Mhx7LYDh5yYv7QEU8dnog8yjNZfIQ6X8kJC1ubP/VDmiphX0vvG8y5zdZU0lOtZr/0L4VhO697ewx58ftugZkFxsHnPdOwqKjjqDxUlpEpU/FEp74XK/YcebLkvE5DLLqVcwtJ+WIHHa5rSTQHX7p5aO6BzPKdIuNDCgl5Tsqt1b3wuHKxVvsciiRZnF4sjVWxU5ix7w1Y2Whr4sV/wQbaSdjMafYwoKzQF/Sl0pZnfIjU7Zb9xQBET]
  - ENC[GPG,hQEMA4nUKMUJFtKCAQgAm9HrL72UUXUje6Vm1r6IPnCP6SPy/7VM15pk9uDjBxX2wN8xoPW6O7B9SO2NuNJCVK9KNPhrP6RGYdEYTR1aMe1ovpZuGEbbhd4KlbzfxuC9qvAcd4Al2iZTje1tDcGLWOjbm3O84T9mbJ/FTaM7RH14CWa2GYAl54UDqTgkOuo9SFIrdTefx5EBtI/1snQc4ZFf7N2CNPc6wO9IbHw83qxGY02fDKa5OE77kAdgHstDHhoGyGyijmquVjgEtnwTyWDlO/3fzIH2GEwLupqvzV8s9uuTQrRaXe9qcPe8IdodJPp5afluHiLm+TtPGEkv9Osdsh1bOaCE+7erADcJe4UBDAPEqAo7p1ScpQEH/3Z33xfe4gidUuUGqUOC0tUBO3d8uP6pjpgQT2MBFHbaSwD7oI4QVRqCc4YNMxqvzhRAbGQFV6InWLuUFXptOlUKJ6MErtl5sFY9hjnO5zmB8V8FbvLMeiMRdAd4rkp6DBoIb3SN0PyRnuundoYqWv1roomeQSfGUvQYGdQHg6n+8i+tBKPxxhlpIMG05GAeDVAMF4TH/gpQe8C+G6/gls6TGEGJhTo/x5y3lXEe9Wfe/wswntBfI8eWWfXq2rk47daOkTVjSYljnBHYvwB31mWjZeGuV1E80lVbxaA7Dr+QpzWHblJjgnegoybO+VKMX/UfDr7zv8Zi4CRw2kDe7ELSTQHh5+VxyojHj9raRw6v6nlE2LbqCsTN1E9Us5aEPG5WPpb7zUIkfCN3Rxeiel06B8Ipq/xez+XFjL0QL/TYL37iIQmQ02/roiTT7hWl]
  - ENC[GPG,hQEMA4nUKMUJFtKCAQf+JXg2fJXrZ8q3Oi1JShPSyCrkUUplDNqgZSSpazZqTkrQ9oQCkHmaVZ1nkR/hngQI6A5o6s4UL6s1UOFLzMsmT7JWPKHvOxlTotsghfRAuMRJR4uM/qzTwILjIDqkIz+u1QX2riXyhYec+wi9eMhMsep5IrWNNogrq0/KkY5wg+NRMlRLU1NjXWm95KhdOpxyQpISTFMPAW805WDVfvvGk1q/7w9tfiIxNa9XhmHgcm1zRbHmvTxlx3thll4GHfeuBLnXSl112dXKmVAG6xvfMvljaOT2oTDYi/e8y6zBuHxAg9k4gDh541z7W6E7AFxnxylQxYauX9KpstFQM06woYUBDAPEqAo7p1ScpQEH/A7tQ7aiqhPRJMTO6vbI8oBkw23/K+TpoDk+SyB+yYMWWgvb7OqZuUv568fl+RqdLSY1Nmh3BXTkijq3Rb4PHOgnWUmSOvyvC6sQGODe5r7HKhbnw5lzLKAboqaqNGEGNwOwC2HQ+ugVO7WilDHsb7PvytArFkMvhod7mF/y+4H1i07qwek1Enord6jL4JKPwV7NIRqn2ZBvvsIEHuv3iposoxPB1Xhkdo4014ROCjL9XczvH3N7dE3faCITyTxKwliZRl4T5XXP8J0GAv1vh/kIyuY6TBEIW/JHDKUW3V4mw+tw4zRDBtsCldulkkd/4LU1gkhKuCnMMHTnOS7FoPHSTQEwzz0nkHF/6ZgP2TrDmaPKoOrCnjmahUExPqwMRBdp5gEHXx7NKaiBQYRSZeJl1RSAgEkvm2vxSxP7BW01zeqwTnMfSyKJzkfVLk5+]
  - ENC[GPG,hQEMA4nUKMUJFtKCAQf/YJ3Vx5r7MEUVY+C4JZ2uXNHA5HjKIsvL6m4RJLuFVzwPwOV3lWq3zAk9SgtTnJfpxxPhil59CZ4HsaI0IlLy4WQzwk56FfVZgY08mcCjBXfVmB9emhOBSmer9ZfJwnFn2SJMuFIEGJfUyKrOhSP4uBsmD4G/Jj7e8EIacLHa75PR94wVCILwtMDm+AQh6mHLIav6KA2LN91vtjkzvwnogug/IfbizJIP043SdgMGJwni3e/XMIjqR9b3ApQaFlkkAV0lK2g24EmVe8NxW23my1VBXBC9fSs0TtCBj/JHx6i/OY/z2c1DD+DlQaL7vl0/x+EKSQnUmHs0wCg5pY4YuIUBDAPEqAo7p1ScpQEH/3wT0ZPhsX2AtTpTK09vXcVMitbwVFFIJmUjaKuF1PR/NA0fXJ6BmImeQhZrK55T2n0rpL/v2ijqtbzVphDiak/1mnGnxBvUJa9luuCCGBizsT8W7oFX8dXrL8TRfeB76p8iqvhU+QPPBGTU1xvyzr3GHKWYjU/1t0ZAi9xGQBi8HvQwwlYuYUBahKT9e296csVjMN8MMEmvxcEAZikvY6OmRlG6A4h7bDKAypTqbM/t8d/pBgSFC0roUzhDHwLkmBPFfhb5yejgQyJSyu8xs5BrkDqeIG82yUyhk289qmkcPRgmJWlu++RGi6AkQ07NqULVjVUPLq3rMoY40FgbXgnSTQHQMWExq6zKKOfL1p30v1uVxt5s4Gya3bnFxb2Bc6ie/p3/IbWD1zPOLR4ikqyQ9Wa3rp5hxN5ufr6I2vxE5AXbXDf5gnI0mpdsPPCJ]
  # yamllint enable rule:line-length
spamassassin::ok_locales:
  # yamllint disable rule:line-length
  - ENC[GPG,hQEMA4nUKMUJFtKCAQf+P6jHgRGLzExuJ5sluUpbOQZ6nEXZKxJhjBDFUWYc0oI1ajO/D4xH4glK8+2kiOCkQVP7XR3WJyO8LBleYg8X9Yj+2KSaMbtzo3qJb2kMRfWYYDYM/qp3OsA5crQZICVQWkuixAzL0Bnp7k/JwdpMsjdWhX7RogUeqaUxVSVa8BxueNTNeSgTUVgS0s4Q3g4GaXhS4Yozxlwfwq12Qv4o3KSaRifYr6DxeYkmpZAFx5muVah5s9/7x481pFi/xefFoRcG6sHIHnogBRfb4w0qRte4IE+VoEYX/r8kuFSqBDJNed2i/E8z9YmEarn7bodgHgGx5DwykDWNFICgJZdkNIUBDAPEqAo7p1ScpQEH/jkyal+VDZbAeEVMkcXjNFzH7mgTWjcjFghJh6+mWHI5Jo9r7vSu7138X1uQQYjKzpOgoWrk2ZhFyFecv+GWU/aMvPpxOsBKszdza/yPeLLOdLSFvqT2XZX/uBY+4PWYkxJHcLzbhVCkWfxlICgAljsVfPZ9H2CfQKKdN7OTAnxhPFT1eksVoXbFMzkoafMtEjuQSZfzB79rt/IV5MhWnP9rUrh2ECs/M1GFR01A7kzaJ3snaoUC5Uqyia1WbtCCjBHgzF2fK2saOEUeZkxZrMsdhCc1CAe8RipW8YkEsau5acNwlW8ZCd+wam2fvCM1uTtERk7j7mECGDECLTeudK3SPQHOn+VytyJEZPGijtY6bUyNYOd1AwroiRi+wOSCVR4SmVmMpRzR7/EVo//8pKQNV+BQSu2ZvVAmHQ3TBRk=]
  # yamllint enable rule:line-length

spamass_milter::config::no_modify_subject: true
spamass_milter::config::options:
  rejectscore: 15

###### / MAIL CONFIGURUATION #####

### WEB ###

nginx::nginx_servers:
  'www.bardicgrove.org':
    add_header:
      # yamllint disable-line rule:line-length
      'Strict-Transport-Security': "max-age=%{lookup('nginx::max-age')}; includeSubDomains; preload"
    ipv6_enable: true
    listen_options: 'default_server'
    ssl: true
    ssl_cert: '/etc/acme.sh/certs/www.bardicgrove.org/fullchain.pem'
    ssl_key: '/etc/acme.sh/keys/www.bardicgrove.org/private.key'
    ssl_redirect: true
    www_root: '/var/www/html'
  'webmail.bardicgrove.org':
    add_header:
      # yamllint disable-line rule:line-length
      'Strict-Transport-Security': "max-age=%{lookup('nginx::max-age')}; preload"
    ipv6_enable: true
    ipv6_listen_options: ''
    ssl: true
    ssl_cert: '/etc/acme.sh/certs/www.bardicgrove.org/fullchain.pem'
    ssl_key: '/etc/acme.sh/keys/www.bardicgrove.org/private.key'
    ssl_redirect: true
    www_root: "/opt/roundcube/roundcubemail-%{lookup('roundcube::version')}"
    try_files:
      - '$uri'
      - '$uri/'
      - '/index.php?q=$uri$args'

nginx::nginx_locations:
  'userContentPHP':
    location: '~ ^/~(.+?)(/.+\.php)$'
    server: www.bardicgrove.org
    location_alias: '/home/$1/public_html$2'
    autoindex: 'on'
    index_files:
      - index.php
    fastcgi: 'localhost:9000'
    fastcgi_index: index.php
    include:
      - fastcgi_params
    ssl: true
    ssl_only: true
  'userContent':
    location: '~ ^/~(.+?)(/.*)?$'
    server: www.bardicgrove.org
    location_alias: '/home/$1/public_html$2'
    index_files:
      - index.html
      - index.htm
      - index.php
    autoindex: 'on'
    ssl: true
    ssl_only: true
    priority: 501
  'rc-deny1':
    location: '~ ^/(README.md|INSTALL|LICENSE|CHANGELOG|UPGRADING)$'
    server: webmail.bardicgrove.org
    www_root: "/opt/roundcube/roundcubemail-%{lookup('roundcube::version')}"
    location_deny:
      - all
    ssl: true
    ssl_only: true
  'rc-deny2':
    location: '~ ^/(config|temp|logs)/'
    server: webmail.bardicgrove.org
    www_root: "/opt/roundcube/roundcubemail-%{lookup('roundcube::version')}"
    location_deny:
      - all
    ssl: true
    ssl_only: true
  'rc-php':
    location: '~ \.php$'
    server: webmail.bardicgrove.org
    www_root: "/opt/roundcube/roundcubemail-%{lookup('roundcube::version')}"
    try_files:
      - '$uri'
      - '=404'
    fastcgi: 'localhost:9000'
    fastcgi_index: index.php
    fastcgi_param:
      SCRIPT_FILENAME: '$document_root$fastcgi_script_name'
    include:
      - fastcgi_params
    ssl: true
    ssl_only: true
  'squirrelmail':
    location: '/webmail'
    rewrite_rules:
      - '^/webmail(.*)$ https://webmail.bardicgrove.org redirect'
    server: www.bardicgrove.org
    ssl: true
    ssl_only: true

php::extensions:
  gd:
    package_prefix: php-
    provider: dnf
  json:
    package_prefix: php-
    provider: dnf
  ldap:
    package_prefix: php-
    provider: dnf
  mbstring:
    package_prefix: php-
    provider: dnf
  mysqlnd:
    package_prefix: php-
    provider: dnf
php::fpm_user: nginx
php::fpm_group: nginx

# webmail
roundcube::version: 1.4.10
# complete edition
# yamllint disable-line rule:line-length
roundcube::checksum: a3d8c0dc4db70188f4aea3b62c1bd8b0b31b0c0f77f77138c0715e9d6ddd520f
roundcube::archive_provider: puppet
roundcube::composer_manage: false
roundcube::db_type: mysql
roundcube::db_name: roundcube
# yamllint disable-line rule:line-length
roundcube::db_password: ENC[GPG,hQEMA4nUKMUJFtKCAQgAtMPWhwARnqgqj9QkQhpG928p3u4ev3tDSC0uwga/zzUtw6YWYQDKGzpO5Qn6ZWgpxDTgAPv7+AsQqSOKYUza63JyZc82Wu11qT400j08BlPlYnnNCcMdWfhBWySRDvgbbpu/pxmMerJoyuzPlq+74mYHLJxbuxUR3ib1Seqbo7HJAj3Eh2jgfqZYYGQvzQJcDknkHnd09CUGVdk3sAFiIrcnnyxXgQQpSNOkJyVf7GcA0643CP/kyqVX2bNhyaABQ0Jg05s2PNBRxzkau+ox7VyxyLF4KKMfrHo23pIoUPXWx7bY5Wmx5PMVIoPdwkBa5Tx7Y7KJoHIVqq57pkhywYUBDAPEqAo7p1ScpQEH/itgWOtkTnbir8BMsp13bohfLTVXaA83JFPq52jrf+VWJqr90XAE+O6gfLJNExkLZJ+3igREfssev+E9AikFVnPOQE48yEhl2IdHSyt6WsUVyZy2rNghMQgBHVN9hqgwN9hzrRgfqngyDAkU8yr0yPTBmuAjVvyyKCMLqSQr0xZOPINe5ZEqUm4FEprmUCu+JZ5cgDGebBfyyi3IA1te5U2vRKkoayU9fIXdEUW7EH9iY/0ZwwSUGJE7hIcDUuoTLM4YNQk8C8Qt22vFOmVAavMr+7BMv3i1UFSC7pKrg6/0TDigedL/kCFBaH9R59OhFGpwja/kjP6eP8RkI+A457vSZQGof+rCCV7te8EZ4f/x+8pLe16a9OpHfcKxdlFh9HauxhAez98ZJif+QdpbiLDHp20QBS/DluV0FAbac89AMbPSjsFqWPM+OuvBQC15G7PZoUSmWWNUxNOxOe4U/Nfdrt73fDof]
roundcube::db_resource_tag: "%{lookup('localexporttag')}"
# yamllint disable-line rule:line-length
roundcube::des_key: ENC[GPG,hQEMA4nUKMUJFtKCAQgApzBrTuwewzERMVHoh9ES9NNpeol60qtxLfRucRpR73hqN7jTkvrOzdsyL4uyViAgWPMZE9wNLJQNNzHKwgXJQfeEOgPeCTnbaw6p/jVFcGCL6MrokG8BnjBfwSX94By30rF2nVIc6nZwu0z5LadfE9dFSjtAEvSlWp5vdjjrh2LeSmC6KCNqo1mpUjdfXa+pu++d8AN5HGpu9euiq811xua5UfqpxzXq8AlKDk8sUKVgrs2TBmIaKCZiv7Dcw/fHUYdkaBkyln2D8FZWBERInRTdVp+zXdOS+dPmxt2Vs4gW6b76r543KUX7nRbbD0ZaebNSKWBZR1NOWTjj03+Qf4UBCwPEqAo7p1ScpQEH+MpUC62V0YeCAHy8J7GvUk5WC0DiNy93kA4mfyMksw9HsGXQIJEvCjVWvsFU/0O/mZFZvIR7ONlXO61yanpDwwsa/bGpdYwOiy/SpENjKD9pE0JVxTDEnaLhY7uKOjkMVbx9gpvmyDOQDA+Vrq27sD18xTb7yD8pwgZWq0qvk6n3Yyx6YLYF8i7KmZoywUyudGRxJvm1ZciZudZz+TCInnhDcfKXiHFREOJFaxKBO7yjTXDsRfrq0sLYIADQyK6GOKNlWBwi1Kt2jbbvqYQtdaCOJvdkZaZdlhh2Rot2Vt/H6vSQJbrZkheyGT4zzG9nKgvI3kVHom5phMw+bgv3kdJlAYqvKqaud9Q7Vxvwm79FYlFuU/QspN8ElpcE+PJsGga4Spiyqiu+8TC7pxJjwSMILaYKvqRHcz88gpU0R2wa1Tbyc1rl+KGVxJilfejpeo8AeF7cAcYw83sMS34FUCp1SE7BGoU=]
roundcube::imap_host: ssl://mail.yul.bardicgrove.org
roundcube::imap_port: 993
roundcube::install_dir: /opt/roundcube
roundcube::package_dir: /var/cache/puppet-archives
roundcube::plugins:
  - managesieve
roundcube::process: nginx
roundcube::options_hash:
  # We don't have an SNI cert for this so we _must_ use the actual postfix
  # defined name
  smtp_server: tls://smtp.bardicgrove.org
  mail_domain: bardicgrove.org

### WEB ###

# selinux tunables #
selinux::selbooleans:
  httpd_can_network_connect:
    persistent: true
    value: 'on'
  httpd_can_network_connect_db:
    persistent: true
    value: 'on'
  httpd_enable_homedirs:
    persistent: true
    value: 'on'

selinux::fcontexts:
  "/opt/roundcube/roundcubemail-%{lookup('roundcube::version')}/logs":
    setype: 'httpd_sys_rw_content_t'
  "/opt/roundcube/roundcubemail-%{lookup('roundcube::version')}/temp":
    setype: 'httpd_sys_rw_content_t'

custom_profiles: profile::smtp::opendmarc
