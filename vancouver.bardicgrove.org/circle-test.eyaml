---
role: role::allinone

# use letsencrypt staging for now
acme::certificate::letsencrypt_ca: staging
acme::certificates:
  # www and webmail are both hosted from nginx so it needs to be SNI (SAN)
  'www.vancouver.bardicgrove.org webmail.vancouver.bardicgrove.org':
    use_account: "%{lookup('acme::certificate::use_account')}"
    use_profile: "%{lookup('acme::certificate::use_profile')}"
    letsencrypt_ca: "%{lookup('acme::certificate::letsencrypt_ca')}"

# msyql
mysql::resourcetag: allinone
mysql::server::remove_default_accounts: true
mysql::server::restart: true
# yamllint disable rule:line-length
mysql::server::root_password: ENC[GPG,hQEMA4nUKMUJFtKCAQf/U1sImKYsUk2Kkrb0Xn702DyZ2C1ZmO8mDTEpOOotP3RaIoVRUUWOvcrZgm4PzJ7licZIAmFBTgGXVEr8Z0DwvykfpPMc+Zzv07qGLyhMSfjT2TXQaLPjRmAMH0yOUjF3WZegZPpurGPkEsCYmNdX8b0MlxX4Y/qFXoPspkGUdGgAKk6dZzS+HT5geubVTIgn6hQfGr3AvDMgNPnC8i80+tQDVXTJnuExTo9Fp0GywfQ1lJvNloeHoHv7a/jd5mXhHmbkJA/7njI96ConcYGUZ74d4oevm8L1X1SAERlenMV1fpgY3C6Mop+3XCHsC0xJ0Rahzvq0ATHEeuw9VVCRoYUBDAPEqAo7p1ScpQEH/AmZTrTttnnPmBAtJNr8l0IkBK1ZFhtZE5rRK2AXHGgv0ITOcvRrlZFkgxI5TTLRluHOQ9ta/6cm6t+OwmTEXAzzmAkjB0EVO30xuqe0yxtkT9lFx7YYs2NJlTTAZPpcTyaA5i3dbPS2EYyQAi0bh/ht7N3vPcH6GtJSsmiwA9UveEafoyBJ48bioUXEpE3Q4SSoyZ1NEiLN2O+60g1ZD/lgw6zwu3XVH7ZOw20scpAb5VbMNDX+AFQI/m0/mEFDrjy+skj+NW1uezlmfgMOkBxWER5p6cccgthMgX2M/6u9Frf/HE8fcs768nk3cCMmghrafO8dcPdWk+HTpXK8gLvSZQFE/0UzXwZ6cmIguvz0MEoR4DwOHQnSPpeH9Zqu+Ve/jISmCN/t1por5XykE85YIM1c3WFURrZoAw7a7aYqHhF0gqUEfEp92E5dJesaXyPFLnDeAipMEnKvIQwiAwEheuVUnXZ0]

###### MAIL CONFIGURUATION #####

# clamav/freshclam
clamavmilter::new_clamav_packages: true
clamav::data::manage_package: true
clamav::data::package_ensure: present
clamav::data::package_name: clamav-data
clamav::clamd::config: /etc/clamd.d/scan.conf
clamav::clamd::package_name: clamd
clamav::clamd::service_name: clamd@scan
clamav::clamd::config::local_socket: '/var/run/clamd.scan/clamd.sock'
clamav::clamd::config::logsyslog: 'yes'
clamav::clamd::config::tcp_socket: 3310
clamav::clamd::config::database_directory: /var/lib/clamav
clamav::clamd::config::user: clamscan
clamav::clamd::config::allow_supplementary_groups: 'yes'
clamav::freshclam::manage_package: true
clamav::freshclam::manage_sysconfig: true
clamav::freshclam::package_ensure: present
clamav::freshclam::package_name: clamav-update
clamav::freshclam::config::database_directory: /var/lib/clamav
clamav::freshclam::config::update_log_file: /var/log/clamav/freshclam.log
clamav::freshclam::config::log_syslog: 'yes'
clamav::freshclam::config::database_owner: clamscan
clamav::freshclam::config::database_mirror: db.local.clamav.net

# dovecot
dovecot::plugins:
  - imap
  - lmtp
  - pop3
  - sieve
dovecot::config:
  protocols: imap lmtp pop3 sieve
  hostname: 'mail.bardicgrove.org'
dovecot::configs:
  '10-auth':
    auth_mechanisms: plain login
    auth_username_format: '%n'
    disable_plaintext_auth: 'yes'
    passdb:
      driver: pam
    userdb:
      driver: passwd
  '10-master':
    default_process_limit: 200
    default_client_limit: 1200
    'service auth':
      unix_listener /var/spool/postfix/private/auth:
        user: postfix
        group: postfix
        mode: '0660'
    'service lmtp':
      unix_listener /var/spool/postfix/private/dovecot-lmtp:
        user: postfix
        group: postfix
        mode: '0660'
  '10-ssl':
    ssl: 'required'
    ssl_cert: '</etc/acme.sh/certs/mail.bardicgrove.org/fullchain.pem'
    ssl_dh: '</etc/pki/dovecot/private/dh.pem'
    ssl_key: '</etc/acme.sh/keys/mail.bardicgrove.org/private.key'
  '15-lda':
    recipient_delimiter: '-'
    lda_mailbox_autosubscribe: 'yes'
  '20-lmtp':
    protocol lmtp:
      mail_plugins: sieve
  '90-sieve':
    plugin:
      sieve: file:~/sieve;active=~/.dovecot.sieve
      recipient_delimiter: '-'

# opendkim
opendkim::keys:
  - domain: bardicgrove.org
    selector: default
    # yamllint disable-line rule:line-length
    publickey: "p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCSF9NGiLU4Yy2x8yy0xogvk2Hm5x9qBUK4IFomxrEzOi1h2Dkjq693H0WVxhtDvCx2dt4FToVcht5DlMZrNfu/sF7Chzw1L43C/y9rbPPiAk8aoLZVAK/3HOdjTjf1kYyNryuVlRX6/vnhFNQz3CFBaPyhf3Gr5EpkguF+f0f53QIDAQAB"
    # yamllint disable-line rule:line-length
    privatekey: ENC[GPG,hQEMA4nUKMUJFtKCAQgAwn4Z5QiHbAyqwck6umNhIVC6GniI2HKbinE8mKb6VFVBLoSMhs+UPPN6HcdekLMBK6kZ72WR9IHTQN8oeAdca74rql/c9tLURdz7qaorP85xiUCRISSZiNe4LSmXJ9IXcOLtW/ICVgRQtV4ZC7YR+LkypnSMfiyZN5N+qacTpLyYAVAqUWFdDTXo6S4f67LYfDTtrJOzozBvXcoL6mhFYCsXk8RHc+8ueEEV9InolL/29+fDiQiofV0e87uaQPSGkhrxby5NvtstQC5Vvjy5+uLPXfZ8aICoEd33pOMx/d7RBNwxb4I1YCr3W500/nZV/q+BpaVPCRMtkhYED42KWoUBDAPEqAo7p1ScpQEIAJFFNAb8nBox/svGi9uIzRSuA1m+EdS1MbPA50r6LlcAahOh7gTzt57hVmbKW0XmEsU8aW8/OA0eZV+ChQlM3/LqO0hbYOn9eiVnigO3knVgv7QpiXpImT0Q3TI0ODv0LsOaF75lKg8mgaVfECgF8P5eJniPon7IiHWZCa0LGEteZ4Wk2i8jDMnow8ZYKpVDkCqmfjawD11jgxBjdlShBBadfv/iOnS2HiXn9nPPT+BeHpQo3rJfANEVdBnVgtLAhLDOSH5yDV8NKrF/x0W27KmrA+XDTkKFCB4XF/amUrV4EAMAuI/eJhosLV49oPg/EPU4TXVV59KNx2rJqDVgYtvS6QFsRYJpS+WOsqyo90SDswS21Qwu6Ro9gAgOy3b8CsBTGhdvp20q07k7+HocWfm/70IaUH0BbjCYwQkqH9koz+/ifAloufd38Oe26Llz2FaZXzF7zHwjGEGx4z5YE7Ps/hPVcHYvskt21ct/dMa7Lo8YuEAQUhbZx5WfSLkFCblvg+wPr9PDMF1NoginduqdIN8puOIHTNHrkBpm9fWCvgihxJHeWl9eBGFoj74A6EmaVhHZrUTdCyksxj/lefoQGgjZiTUs9z6IMSw97sGbE48bTmycDlZ9Zcgg1KTN8EwjIAgIzcXz216knFf7Ls/xNmfqgG7kqNA7bFLkz1HP8gsI4c9O4QmbpuH+hl09cyJFsOdiwqD+6zod1VNtWXfUPbijEeb14V7D8YXUaAoOzPfh4TMUHLirLfF9AQ73/ZHntOwn6IhKLERgeWjalyiOT75gyPNbYw3e2ccO++E/fyus3dWHKgc2TiNxUNhJg4O0bQjfPt8pqHMLM0wWanLORcuYLYk1qpTY0iwoyeBAUrPdQKIUdXROSKe7XCTbB06nwJFqjEhfCGEkih/4BDfyfpa05FYA4YrUPBdFFtXwc1JUuuytLWRk0YLhHHqYbcKBUOcbcj0QQKmkpbkmU1+1/jY+9zLKB/U5ak8AXOgIq0q99azyLHZnp56hCeSqz8gDwEDJyRnvoGyblFJtdH8MX2BFyAa7tODKR5ydnSz9dFCGNjaV+T/xA8Ix9Y7u3B31u8YK7JeRYtq9tS532sjlfK2YW75su5OQNuFO69f94tsa29+OaFmYKz4HcYArdK5+JJlioWPkH1qbLmNcaykThbigaUPKGGmBegQiJVsqYWbHo9tahwpzRXJmdHvshyxnYNyboYjzC93YtwYNB+WbwEXMOjcQeecIUpUFKqYOf3jOMacTL1sGZj+c4B2BComuerBg+3hheWqKoAANOHjfCE6F0MBvXt6o89ZU5dV5WA1Pr1p1vLgnOReESp7nQXrik8R2wzUajadOojjSJD9t6/Wr]
    signingdomains:
      - '*@bardicgrove.org'

# postfix
postfix::configs:
  dovecot_destination_concurrency_limit:
    value: '1'
  dovecot_destination_recipient_limit:
    value: '1'
  home_mailbox:
    value: 'Maildir/'
  mailbox_transport:
    value: lmtp:unix:private/dovecot-lmtp
  # We use ~20MB as the limit as _most_ major providers will reject mail much
  # larger than this
  message_size_limit:
    value: '20480000'
  myhostname:
    value: 'smtp.bardicgrove.org'
  recipient_delimiter:
    value: '-'
  smtpd_sasl_auth_enable:
    value: 'yes'
  smtpd_sasl_path:
    value: private/auth
  smtpd_sasl_security_options:
    value: noanonymous, noplaintext
  smtpd_sasl_tls_security_options:
    value: noanonymous
  smtpd_sasl_type:
    value: dovecot
  smtpd_tls_auth_only:
    value: 'yes'
  smtp_tls_CAfile:
    ensure: absent
  smtp_tls_CApath:
    ensure: absent
  smtpd_tls_cert_file:
    value: /etc/acme.sh/certs/smtp.bardicgrove.org/fullchain.pem
  smtpd_tls_chain_files:
    ensure: absent
    value: '/etc/acme.sh/keys/smtp.bardicgrove.org/fullchain_with_key.pem'
  smtpd_tls_key_file:
    value: /etc/acme.sh/keys/smtp.bardicgrove.org/private.key
  smtpd_tls_security_level:
    value: may
postfix::mta: true
postfix::relayhost: direct
postfix::smtp_listen: all
postfix::use_dovecot_lda: true
postfix::master_entries:
  # yamllint disable-line rule:line-length
  - 'spamassassin unix -     n       n     -         -       pipe user=spamassassin argv=/usr/bin/spamc -e /usr/sbin/sendmail -oi -f ${sender} ${recipient}'
postfix::master_submission: 'submission inet n - n - - smtpd'

# spamassassin
spamassassin::pyzor_enabled: false
spamassassin::razor_enabled: false
spamassassin::sa_update: true
spamassassin::service_enabled: true
spamassassin::spamd_min_children: 1

###### / MAIL CONFIGURUATION #####

### WEB ###

nginx::nginx_servers:
  'www.vancouver.bardicgrove.org':
    ipv6_enable: true
    ssl: true
    ssl_cert: '/etc/acme.sh/certs/www.vancouver.bardicgrove.org/fullchain.pem'
    ssl_key: '/etc/acme.sh/keys/www.vancouver.bardicgrove.org/private.key'
    www_root: '/var/www/html'
  'webmail.vancouver.bardicgrove.org':
    ipv6_enable: true
    ssl: true
    ssl_cert: '/etc/acme.sh/certs/www.vancouver.bardicgrove.org/fullchain.pem'
    ssl_key: '/etc/acme.sh/keys/www.vancouver.bardicgrove.org/private.key'
    www_root': '/opt/roundcube/roundcubemail-1.4.4'

nginx::nginx_locations:
  'userContent':
    location: '~ ^/~(.+?)(/.*)?$'
    server: www.vancouver.bardicgrove.org
    location_alias: '/home/$1/public_html$2'
    index_files:
      - index.html
      - index.htm
    autoindex: 'on'
    ssl: true
  'rc-root':
    location: '/'
    server: webmail.vancouver.bardicgrove.org
    try_files:
      - '$uri'
      - '$uri/'
      - '/index.php?q=$uri$args'
  'rc-deny1':
    location: '~ ^/(README.md|INSTALL|LICENSE|CHANGELOG|UPGRADING)$'
    server: webmail.vancouver.bardicgrove.org
    location_deny:
      - all
  'rc-deny2':
    location: '~ ^/(config|temp|logs)/'
    server: webmail.vancouver.bardicgrove.org
    location_deny:
      - all
  'rc-php':
    location: '~ \.php$'
    server: webmail.vancouver.bardicgrove.org
    try_files:
      - '$uri'
      - '=404'
    fastcgi: 'localhost:9000'
    fastcgi_index: index.php
    fastcgi_param:
      SCRIPT_FILENAME: '$document_root$fastcgi_script_name'
    include:
      - fastcgi_params

php::extensions:
  gd:
    package_prefix: php-
    provider: dnf
  json:
    package_prefix: php-
    provider: dnf
  ldap:
    package_prefix: php-
    provider: dnf
  mbstring:
    package_prefix: php-
    provider: dnf
php::fpm_user: nginx
php::fpm_group: nginx

# webmail
roundcube::archive_provider: puppet
roundcube::composer_manage: false
roundcube::db_type: mysql
# yamllint disable-line rule:line-length
roundcube::db_password: ENC[GPG,hQEMA4nUKMUJFtKCAQf/fganzoOHrmpqhbc7HI8NNDjw1NKSvnQfcKlGel6CFWPpxKs1ILxsdwDh8sajZyWBno+OYkc38x69YnfibQ92rvgLbfxXHHLJj5dmidQHHkguaTCxYGT4NsamMFE91OKYKt/SIDIpDBBXIHrDXAxbuGlUkinaqhtAAEHmFvYPI6pA2LLfHKhbDNQ5lKVz/CA/O0vZjI5kBUU8+wUfQ6sysHxz3acqIU9QOffPx/rpXtfi8EtF6qvChnif67vBLHtM8ZniIN+CWP9At1EWKYF3oz9DIpCpH1HEL5LAPu9PdhXg4TijZOaLSrv8mCV/Rw9Fx116M9BRaFDSitlk+bNfzIUBDAPEqAo7p1ScpQEIAMap0pV3VpM1nukfBQy9+XLzHEpTrxoe+yzxJFGg5XLdsBl/0u9Q9x+CbqkggJECZ8vdmTwtyPe5KoLdFZ00F7442ANz0fh5p4gtT/nLmJ8jn2cWLAUshEpUKl8DCWenHnzMYJUvdRBz5P3yZlFWHoVxgZyfWyXxUxamDNPG6VoC1ThUWvl8sbQ4oHZgKckh24N7lBLqu7amIvYkI4a++krTApgdaUABN2Y4iMCU26dmv/q4YHQ0DVtEcxGHuZ6rv5n44CSmBIoGjJxofQPnpxLft0NgMRgEGcXiyhJUsSYaFJqGJFrMq35kxKRq2b/vRI4XxMrno9NO/DGBNP3G3fPSZQHagPVIqUx+csO+JbgXIdUsNwgqeGq5yLamVFajsv1XuvfIraKfWgEdoi/Qgd2n5dORSNjEs5WdR/V5/N1UXoheQlGxnOyVUrFC4wET9GJ+z5SzaQ3PW86/shWqnS84AEDaHgHw]
roundcube::db_resource_tag: allinone
roundcube::install_dir: /opt/roundcube
roundcube::package_dir: /var/cache/puppet-archives
roundcube::process: nginx

### WEB ###

# selinux tunables #
selinux::selbooleans:
  httpd_enable_homedirs:
    persistent: true
    value: 'on'
